---
title: "R_basic5"
author: "York Lin"
date: "2020年02月04日"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Classification
### review
```{R}
library(modeldata)
data(mlc_churn)
str(mlc_churn)

#選擇建模變數
variable.list = !names(mlc_churn) %in% c('state','area_code','account_length')
mlc_churn=mlc_churn[,variable.list]

str(mlc_churn)

set.seed(222)
#把資料分成training data 和 testing data
ind<-sample(1:2, size=nrow(mlc_churn), replace=T, prob=c(0.7, 0.3))
trainset=mlc_churn[ind==1,]
testset=mlc_churn[ind==2,]

library('rpart')
library('rpart.plot')
churn.rp<-rpart(churn ~., data=trainset)
s = summary(churn.rp)

rpart.plot(churn.rp)

printcp(churn.rp)

min_row = which.min(churn.rp$cptable[,"xerror"])
churn.cp = churn.rp$cptable[min_row, "CP"]
#將churn.cp設為臨界值來修剪樹
prune.tree=prune(churn.rp, cp=churn.cp)
rpart.plot(prune.tree)

library('caret')
library('e1071')
predictions <-predict(prune.tree, testset, type='class')
table(predictions,testset$churn)
confusionMatrix(table(predictions, testset$churn))
```

### use caret package
```{R}
#install.packages("caret")
library(caret)
control=trainControl(method="repeatedcv", number=10, repeats=3)

model =train(churn~., data=trainset, method="rpart", trControl=control)

predictions = predict(model,testset,type='raw')
table(predictions,testset$churn)
confusionMatrix(table(predictions,testset$churn))
```

### caret 套件使用說明
```{R}
# 查詢caret package 有實作的所有演算法
names(getModelInfo())
# 查詢caret package 有沒有實作rpart演算法
names(getModelInfo())[grep('rpart',names(getModelInfo()))]
# 查詢rpart model資訊
getModelInfo('rpart')
# 查詢rpart model可以tune的parameters
getModelInfo('rpart')$rpart$parameters
```

### caret tune
```{R}

control=trainControl(method="repeatedcv", number=10, repeats=3,summaryFunction = multiClassSummary,classProbs=T)

tune_funs = expand.grid(cp=seq(0,0.1,0.01))

model =train(churn~., data=trainset, method="rpart", trControl=control,tuneGrid=tune_funs,metric="AUC")

model
predictions = predict(model, testset)
confusionMatrix(table(predictions,testset$churn))
```

### find importance variable
```{R}
library('caret')
importance = varImp(model, scale=T)
importance
plot(importance)
```

### ROC
- https://www.youtube.com/watch?v=OAl6eAyP-yo
- http://www.navan.name/roc/

```{R}
#install.packages("ROCR")
library(ROCR)
predictions <-predict(model, testset, type="prob")
head(predictions)
pred.to.roc<-predictions[, "yes"]
head(pred.to.roc)
pred.rocr<-prediction(pred.to.roc, testset$churn)
pred.rocr
perf.rocr<-performance(pred.rocr, measure ="auc")
perf.tpr.rocr<-performance(pred.rocr, measure="tpr",x.measure = "fpr")
plot(perf.tpr.rocr,main=paste("AUC:",(perf.rocr@y.values)))
```


- http://www.rpubs.com/skydome20/R-Note16-Ensemble_Learning
### 補充：隨機森林(Random Forest)
```{R}
#install.packages('randomForest')
library(randomForest)
library('caret')
library('e1071')
library(ROCR)

rf_model = randomForest(formula=churn ~ .,data=trainset)
#find best ntree
plot(rf_model)
legend("topright",colnames(rf_model$err.rate),col=1:3,cex=0.8,fill=1:3)
#find nest mtry
tuneRF(trainset[,-17],trainset$churn)

model = train(churn~.,data=trainset,method='rf',tuneGrid=expand.grid(mtry=c(2,4,8)))

rf_model <- randomForest(churn ~., data = trainset, ntree=50,mtry=8)
# rf_model = train(churn~.,data=churnTrain,method='rf')
confusionMatrix(table(predict(rf_model,testset),testset$churn))

rf.predict.prob <- predict(rf_model, testset, type="prob")
rf.prediction <- prediction(rf.predict.prob[,"yes"], as.factor(testset$churn))
rf.auc <- performance(rf.prediction, measure = "auc")
rf.performance <- performance(rf.prediction, measure="tpr",x.measure="fpr")
plot(rf.performance)
```


#### 比較CART和RandomForest
```{R}
tune_funs = expand.grid(cp=seq(0,0.1,0.01))
rpart_model =train(churn~., data=trainset, method="rpart",tuneGrid=tune_funs)

rpart_prob_yes = predict(rpart_model,testset,type='prob')[,1]
rpart_pred.rocr = prediction(rpart_prob_yes,testset$churn)
rpart_perf.rocr = performance(rpart_pred.rocr,measure = 'tpr',x.measure = 'fpr')

plot(rpart_perf.rocr,col='red')
plot(rf.performance,col='black',add=T)
legend(x=0.7, y=0.2, legend =c('randomforest','rpart'), fill= c("black","red"))
```

