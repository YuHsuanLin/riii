---
title: "R_basic3"
author: "York Lin"
date: "2020年01月30日"
output: html_document
editor_options: 
  chunk_output_type: console
---

### p90 practice
```{R}

match_func = function(filename,header=F,sep='|'){
  match = read.table(filename,header = header,sep=sep)
  mat = matrix(data=rep(-1,25),nrow=5)
  rownames(mat) = c("A","B","C","D","E")
  colnames(mat) = c("A","B","C","D","E")
  for (i in 1:nrow(match)){ 
    mat[match[i,1],match[i,2]] = match[i,3] 
  }
  return(mat)
}

match_func = function(filename,header,sep){
  match_df = read.table(filename,header = header,sep=sep)
  mat = matrix(data=-1,nrow=length(levels(match_df[,1])),ncol=length(levels(match_df[,2])),dimnames = list(levels(match_df[,1]),levels(match_df[,2])))
  for(i in 1:nrow(match_df)){
    mat[match_df[i,1],match_df[i,2]] = match_df[i,3]
  }
  return(mat)
}
```

### 統計圖
```{R}
setwd("~/lecture/riii")
load("./Statistics/cdc.Rdata")
cdc$exerany = as.factor(cdc$exerany)
cdc$hlthplan = as.factor(cdc$hlthplan)
cdc$smoke100 = as.factor(cdc$smoke100)
str(cdc)

#屬貭資料
#長條圖
barplot(table(cdc$smoke100))
?barplot
barplot(table(cdc$smoke100),xlab='有無吸菸',ylab='人數',main='有無吸菸習慣',col='blue',family="Songti SC")

#圓餅圖
pie(table(cdc$smoke100))
pie(table(cdc$genhlth))

# col參數可以帶入index,字串,色碼
pie(table(cdc$genhlth),col = rainbow(5))
pie(table(cdc$genhlth),col = c(1,2,3,4,5))
pie(table(cdc$genhlth),col=c("black","red","green","blue","yellow"))

rainbow(5)
#加上各分類比例
pct = round(table(cdc$genhlth) / length(cdc$genhlth) *100,1)
labels = paste(names(pct),pct,"%")
pie(table(cdc$genhlth), labels = labels)

#馬賽克圖
gender_smokers = table(cdc$gender,cdc$smoke100)
mosaicplot(gender_smokers)
```

### 統計圖(續)
```{R}
#屬量資料

#直方圖
hist(cdc$height)

par(mfrow=c(1,3))
hist(cdc$height)
hist(cdc$height,breaks = 30)
hist(cdc$height,breaks = 50)

#莖葉圖
stem(cdc$age)
tmp=sample(cdc$age,100)
stem(sample(cdc$age,100))
?stem
stem(sample(cdc$age,100),scale=2)

#盒鬚圖
par(mfrow=c(1,1))
boxplot(cdc$weight)
boxplot(cdc$weight, horizontal=TRUE)
boxplot(cdc$weight ~ cdc$gender)
boxplot(cdc$height ~ cdc$gender)

bmi = (cdc$weight/cdc$height^2) * 703
boxplot(bmi ~ cdc$genhlth)

#觀察兩組資料間關係:點散布圖
plot(cdc$weight, cdc$height)
plot(cdc$weight, cdc$wtdesire)

plot(cdc[,c('height','weight','wtdesire')])

png(filename='./test123.png')
plot(cdc$weight, cdc$height)
dev.off()
```

## data explorer
## create_report() error 99 problem
## downgrade pandoc 2.7 -> 2.6
- https://github.com/boxuancui/DataExplorer/issues/116

```{R}
#install.packages('DataExplorer')
library('DataExplorer')
help(package = 'DataExplorer')

introduce(iris)
dummify(iris)
plot_missing(iris)
plot_histogram(iris)
plot_boxplot(iris,by='Species')
plot_correlation(iris[,-5])
plot_prcomp(iris)
#create_report(iris)
```

### package:ggplot2
##### documentation
- http://docs.ggplot2.org/current/

##### cheat sheet
- https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf

##### why ggplot2?
- fancy by default, good for demo and report 
- consistent across all kinds of plot in syntax and behavior
- strong support community(the mostly download package on CRAN)
```{R}
#basic syntax
#ggplot(data,aes(x,y,group,...))+geom_object(...)

#install.packages('ggplot2')
library('ggplot2')
g <- ggplot(cdc,aes(x=height,y=weight))
g+geom_point()

g <- ggplot(cdc,aes(x=height,y=weight,col=gender))
g+geom_point()

g <- ggplot(cdc,aes(x=height,y=weight))
g+geom_point(aes(col=gender))

g <- ggplot(cdc,aes(x=genhlth))
g+geom_bar()
g+geom_bar() + ylab('次數') + ggtitle('健康狀況長條圖')
#fill => 填滿顏色; color => 邊線顏色
g+geom_bar(fill='snow',color='black')
g+geom_bar(aes(fill=gender),color='black')

g+geom_bar(aes(fill=gender))+ylab("次數")+ggtitle("健康狀況長條圖")
```


### ggplot2(續)
```{R}
## theme
g+geom_bar(aes(col=gender))+ylab("次數")+ggtitle("健康狀況長條圖") + theme(text=element_text(size=16,  family="Songti SC"))

g+geom_bar(aes(col=gender))+ylab("次數")+ggtitle("健康狀況長條圖")+theme_classic()

#stat function
?geom_bar
g <- ggplot(cdc,aes(x=genhlth))
g+geom_bar(stat = 'count')
g+stat_count(geom='bar')

##position
g = ggplot(cdc,aes(x=gender))
g+geom_bar(aes(fill=genhlth),position='stack')
g+geom_bar(aes(fill=genhlth),position='dodge')
g+geom_bar(aes(fill=genhlth),position='fill')
g+geom_bar(aes(fill=genhlth),position='identity')

#facet
g <- ggplot(cdc,aes(x=weight))
g+ geom_histogram()+facet_wrap(~genhlth)
g+ geom_histogram()+facet_grid(~genhlth)
g+ geom_histogram()+facet_grid(gender~genhlth)
```

## antv documentation
- https://antv.alipay.com/zh-cn/vis/chart/index.html

### ggplot2(續)
```{R}
#coordinate
g <- ggplot(cdc,aes(x=genhlth))
g+geom_bar()+coord_flip()

g+geom_bar()+coord_polar(theta = 'x')
g+geom_bar()+coord_polar(theta = 'y')
g+geom_bar(aes(fill=gender))+coord_polar(theta = 'y')

#pie chart
ggplot(cdc,aes(x=1)) + geom_bar(aes(fill=genhlth)) + coord_polar(theta = 'y')
```

```{R}
precounted = as.data.frame(table(cdc$genhlth))
names(precounted)[1]= 'genhlth'
precounted

precounted = as.data.frame(table(cdc$genhlth,dnn = c('genhlth')))
precounted
g2 = ggplot(precounted,aes(x=genhlth,y=Freq))+ geom_bar(stat='identity')

#save
ggsave(filename = './g2.jpg',plot=g2)
```


## Esquisse
## if mac OS cannot install, try this:
####
brew install pkg-config
install.packages("gdtools", type = "source")
devtools::install_github("dreamRs/esquisse")
####
```{R}
#install.packages('esquisse')
#library('esquisse')
#esquisse::esquisser()
```


```{R}
setwd('~/lecture/riii')
load('./Statistics/appledaily.RData')
str(appledaily)
as.POSIXct(appledaily[1,'dt'],format='%Y年%m月%d日%H:%M')

#比較as.POSIX() 和 as.Date()
unclass(as.POSIXct(appledaily$dt,format = '%Y年%m月%d日%H:%M'))
unclass(as.Date(appledaily$dt,format = '%Y年%m月%d日%H:%M'))


#比較as.POSIXct() 和 as.POSIXlt()
t1 = as.POSIXct(appledaily$dt,format = '%Y年%m月%d日%H:%M')
class(t1)
head(unclass(t1))

t2 = as.POSIXlt(appledaily$dt,format = '%Y年%m月%d日%H:%M')
class(t2)
unclass(t2)

appledaily$dt = as.POSIXct(appledaily$dt,format = '%Y年%m月%d日%H:%M')

str(appledaily)
```


### lubridate package
- https://r4ds.had.co.nz/dates-and-times.html
```{R}
#install.packages('lubridate')
library(lubridate)

# Extracting information
now_date = now()

year(now_date)
month(now_date,label=T)
day(now_date)
hour(now_date)
minute(now_date)
second(now_date)
wday(now_date,label=T)

# Parsing dates and times
ymd('2020年01月30日')
mdy('01302020')
dmy(30012020)

ymd('2019/01/29')
ymd('2019.01.29')

ymd('2019.01.29')
ymd_hm('2019/1/29 14:40',tz='Asia/Taipei')

with_tz(ymd_hm('2019/11/26 16:30',tz='Asia/Taipei'),tzone='America/Los_Angeles')

appledaily$dt = ymd_hm(appledaily$dt,tz='Asia/Taipei')
```


### 擷取點擊數中數值部分
"." => 0~多個
\d.
"+" => 1~多個
\d+
"?" => 0 or 1
\d?

- https://r4ds.had.co.nz/strings.html
```{R}
#方法一：利用sub函數取代
tmp = sub("人氣\\(","",appledaily$clicked[1])
tmp2 = sub("\\)","",tmp)
click = as.numeric(tmp2)

clicked = sub('\\)','',sub('人氣\\(','',appledaily$clicked))
clicked = as.integer(clicked)
head(clicked)

#方法二：使用stringr套件的str_match()
library(stringr)
?str_match

clicked = as.integer(str_match(appledaily$clicked,"人氣\\((\\d+)\\)")[,2])

appledaily$clicked = clicked
head(clicked)
```

### 其他常見字串處理函式
```{R}
#sub (取代第一個遇到的字串)
s = "aaa bbb ccc aaa bbb aaa"
sub("aaa","",s)

#利用gsub函數取代 (全局取代)
gsub("aaa","",s)

#grep()  ==> return index
test_str = c('abcd','bcd','cde')
grep('a',test_str)
test_str[grep('a',test_str)]

setwd('~/lecture/riii')
load('./Statistics/applenews.RData')

applenews[grep('中國',applenews$title[1:10]),"title"]

#grepl() ==> return boolean 
grepl('a',test_str)
test_str[grepl('a',test_str)]

#strsplit() ==> 字串分割
splited = strsplit(c('abc-def','ddd-ggg'),'-')
splited
class(splited)

### 取出list裡面部分元素
sapply(splited,function(e){e[1]})

splited_vec = unlist(splited)
length(splited_vec)
seq(from=1,to=length(splited_vec),by=2)
splited_vec[seq(from=1,to=length(splited_vec),by=2)]

#substring() ==> 取得部份字串
test_s = 'abcdef'
nchar(test_s)
substring(test_s,2,nchar('abcdef')-1)
```

### 遺失值處理(missing value)
```{R}
setwd('~/lecture/riii')
load('./Statistics/applenews.RData')

idx= sample(1:nrow(applenews),size=30)
applenews[idx,'clicked'] = NA

#找尋遺失值
is.na(applenews)
sum(is.na(applenews$clicked))

sapply(names(applenews),function(e){ sum(is.na(applenews[,e])) >0 })

cleaned_data = applenews[!is.na(applenews$clicked),]

#移除missing value
complete.cases(applenews)
cleaned_data2 = applenews[complete.cases(applenews),]
str(cleaned_data2)

#以全體平均填補
load('./Statistics/applenews.RData')
applenews[idx,'clicked'] = NA

mean_clicked = round(mean(applenews$clicked,na.rm=T),0)
applenews$clicked[is.na(applenews$clicked)] = mean_clicked

sum(is.na(applenews$clicked))
```

### 遺失值處理(missing value)(續)
```{R}
#以類別平均填補
setwd('~/lecture/riii')
load('./Statistics/applenews.RData')
applenews[idx,'clicked'] = NA

cat_means = tapply(applenews$clicked,applenews$category,function(e){round(mean(e,na.rm=T),0)})
cat_means["3C"]

for(i in names(cat_means)){
  applenews[applenews$category == i & is.na(applenews$clicked),'clicked'] = cat_means[i]
}

sum(is.na(applenews$clicked))
```

### mice
```{R}
#install.packages('mice')
library(mice)
data(iris)
na_list = sample(1:nrow(iris),15)
iris[na_list,'Sepal.Length'] = NA

mice.data <- mice(data=iris,m = 3,method = "cart")

complete(mice.data,1)

complete(mice.data,1)[na_list,'Sepal.Length']
complete(mice.data,2)[na_list,'Sepal.Length']
complete(mice.data,3)[na_list,'Sepal.Length']

##比較各模型預測結果是否穩定(mean接近0,var很小)
diff1 = complete(mice.data,1)[na_list,'Sepal.Length'] - complete(mice.data,2)[na_list,'Sepal.Length']

diff2 = complete(mice.data,1)[na_list,'Sepal.Length'] - complete(mice.data,3)[na_list,'Sepal.Length']

diff3 = complete(mice.data,2)[na_list,'Sepal.Length'] - complete(mice.data,3)[na_list,'Sepal.Length']

mean(c(diff1,diff2,diff3))
var(c(diff1,diff2,diff3))

complete(mice.data,1)
```
