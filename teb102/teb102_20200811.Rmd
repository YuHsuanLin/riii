---
title: "R_DataMining1"
author: "York Lin"
date: "2020年08月11日"
output: html_document
editor_options: 
  chunk_output_type: console
---

### dplyr
```{R}
#install.packages('dplyr')
data("iris")
library('dplyr')

#filter
iris[iris$Species== 'setosa',]
filter(iris,Species=='setosa')

#select
iris[,c('Sepal.Length','Sepal.Width')]
select(iris,Sepal.Length,Sepal.Width)

head(filter(select(iris,Sepal.Length,Species),Species=='setosa'))

#chaining
iris %>%
select(.,Sepal.Length,Species) %>%
filter(.,Species=='setosa') %>%
head(.)

#arrange
iris %>%
  select(Sepal.Length,Species) %>%
  filter(Species=='setosa') %>%
  arrange(desc(Sepal.Length)) %>%
  head(10)

### group_by + summarise
iris %>%
  group_by(Species) %>%
  summarise(sepal_length_mean = mean(Sepal.Length)) %>%
  arrange(sepal_length_mean)

### group_by + summarise_at
iris %>%
  group_by(Species) %>%
  summarise_at(.vars=vars(Sepal.Length,Sepal.Width,Petal.Length,Petal.Width),.funs=funs(mean,median,max,min,sd))

## dplyr 0.8up funs() -> list()
iris %>%
  group_by(Species) %>%
  summarise_at(.vars=vars(Sepal.Length,Sepal.Width,Petal.Length,Petal.Width),.funs=list(mean,median,min,max))
```


### alter mysql 8.0 password encryption
- https://stackoverflow.com/questions/49194719/authentication-plugin-caching-sha2-password-cannot-be-loaded

在MySQL workbench執行以下指令
```
ALTER USER 'yourusername'@'localhost' IDENTIFIED WITH mysql_native_password BY 'youpassword';

CREATE DATABASE test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```
### connect MySQL example
```{R}
#install.packages('dplyr')
#install.packages('RMariaDB')
#install.packages('dbplyr')
library('dplyr')
library('dbplyr')
library('RMariaDB')

data("iris")

conn = dbConnect(MariaDB(),dbname='test',host='127.0.0.1',port=3306,user='root',password='pythonetl')

dbListTables(conn)

db_drop_table(conn,'iris')
#copy_to(conn,iris,temporary = F)

tbl(conn,'iris') %>%
  select(starts_with('Sepal'),'Species') %>%
  group_by(Species) %>%
  summarise_at(.funs=funs(mean(.,na.rm=T),sd(.,na.rm=T)),.vars=vars(starts_with('Sepal'))) %>%
  collect()

tbl(conn,'iris') %>%
  select(starts_with('Sepal'),'Species') %>%
  group_by(Species) %>%
  summarise_at(.funs=funs(mean(.,na.rm=T),sd(.,na.rm=T)),.vars=vars(starts_with('Sepal'))) %>% show_query()

?show_query

dbGetQuery(conn,'select * from iris') %>% filter(Species == 'setosa')
dbGetQuery(conn,'select `Sepal.Length` from iris')
```


## ggplot2
### documentation
- http://docs.ggplot2.org/current/

### cheat sheet
- https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf

### why ggplot2?
fancy by default, good for demo and report 
consistent across all kinds of plot in syntax and behavior
strong support community(the mostly download package on CRAN)

```{R}
#basic syntax
#ggplot(data,aes(x,y,group,...))+geom_object(...)

#install.packages('ggplot2')
library('ggplot2')
g <- ggplot(iris,aes(x=Sepal.Length,y=Sepal.Width))
g + geom_point()

g <- ggplot(iris,aes(x=Sepal.Length,y=Sepal.Width,col=Species))
g + geom_point()

g <- ggplot(iris,aes(x=Sepal.Length,y=Sepal.Width,shape=Species))
g + geom_point()

?aes()

g <- ggplot(iris,aes(x=Sepal.Length,y=Sepal.Width))
g + geom_point(aes(col=Species))

#bar chart
g <- ggplot(iris,aes(x=Species))
g+geom_bar()
g+geom_bar(fill='snow',color='black')
```

```{R}
#stat
g + geom_bar(stat = 'count')
g + stat_count(geom='bar')

# label , title
g + geom_bar(stat = 'count') + ylab('Count') + ggtitle('iris')

#theme
g + geom_bar() + theme(text=element_text(size=16, family="Songti SC"))

g + geom_bar() + theme_gray()

#position
iris$Sepal.Length.Cat = cut(iris$Sepal.Length,breaks= 3,right=F)
levels(iris$Sepal.Length.Cat) = c("Short","Medium","Long")
g = ggplot(iris,aes(x=Species))
g+geom_bar(aes(fill=Sepal.Length.Cat),position='stack')
g+geom_bar(aes(fill=Sepal.Length.Cat),position='dodge')
g+geom_bar(aes(fill=Sepal.Length.Cat),position='fill')
```


```{R}
g <- ggplot(iris,aes(x=Sepal.Width))
g+geom_histogram(aes(fill=Species))

#facet
g <- ggplot(iris,aes(x=Sepal.Width))
g+ geom_histogram()+facet_wrap(~Species)
g+ geom_histogram()+facet_grid(~Species)
g2 = g+ geom_histogram()+facet_grid(Species~Sepal.Length.Cat)

ggsave(filename='./your_file_name.png',plot = g2)
```

## Esquisse
## if mac OS cannot install, try this:
####
#brew install pkg-config
#install.packages("gdtools", type = "source")
#devtools::install_github("dreamRs/esquisse")
####
```{R}
#install.packages('esquisse')
#library('esquisse')
#esquisse::esquisser()
```

### outliers
```{R}
## z-score
scale(iris$Sepal.Width)
iris[abs(scale(iris$Sepal.Width)) > 3,]

library(dplyr)
iris %>% filter(!abs(scale(iris$Sepal.Width)) > 3)

## boxplot
IQR(iris$Sepal.Width)
q1 = quantile(iris$Sepal.Width,0.25)
q3 = quantile(iris$Sepal.Width,0.75)
low_limit = q1 - 1.5 * IQR(iris$Sepal.Width)
up_limit = q3 + 1.5 * IQR(iris$Sepal.Width)
iris$Sepal.Width < low_limit | iris$Sepal.Width > up_limit
iris %>% filter(!iris$Sepal.Width < low_limit | iris$Sepal.Width > up_limit)


boxplot(iris$Sepal.Width)
boxplot.stats(iris$Sepal.Width)
boxplot.stats(iris$Sepal.Width)$out
condition = !iris$Sepal.Width %in% boxplot.stats(iris$Sepal.Width)$out

boxplot(iris[condition,]$Sepal.Width)
```

### missing values
```{R}
na_list = sample(1:nrow(iris),15)
iris[na_list,'Sepal.Length'] = NA

is.na(iris)
sum(is.na(iris$Sepal.Length))

#移除遺失值樣本
complete.cases(iris)
rm.data <- iris[complete.cases(iris), ]
str(rm.data)

#以全體平均值填補
mean(iris$Sepal.Length,na.rm=T)

mean_length = as.numeric(mean(iris$Sepal.Length,na.rm=T))
iris$Sepal.Length[is.na(iris$Sepal.Length)] = mean_length


iris[na_list,'Sepal.Length'] = NA
#以類別平均值填補
cat_means = tapply(iris$Sepal.Length,iris$Species,function(e){as.numeric(mean(e,na.rm=T))})

iris[is.na(iris$Sepal.Length) & iris$Species == 'setosa','Sepal.Length'] = cat_means['setosa']

for(i in 1:length(names(cat_means))){
  iris[iris$Species == names(cat_means)[i] & is.na(iris$Sepal.Length),'Sepal.Length'] = cat_means[i]
}

```

